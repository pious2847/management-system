<!DOCTYPE html>
<html lang="en">
<%- include('./layouts/header') %>

    <body>
        <%- include('./popups/alert') %>

            <div class="container-fluid">
                <div class="row">
                    <%- include('./layouts/sidebar') %>
                        <!-- Mobile Overlay -->
                        <div class="mobile-overlay"></div>
                        <div class="main-content p-3">
                            <%- include('./layouts/topnav') %>

                                <div class="content-wrapper my-5">
                                    <!-- Sales Overview Cards -->
                                    <div class="row mb-4 gap-3 summaryCardsContainer">
                                        <div class="col-md-3">
                                            <div class="card bg-primary text-white">
                                                <div class="card-body">
                                                    <h5 class="card-title">Total Sales</h5>
                                                    <h2 class="card-text" id="totalSales">₵<%= totalSales.toFixed(2)  %></h2>
                                                    <p class="card-text"><small>Last 30 days</small></p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card bg-success text-white">
                                                <div class="card-body">
                                                    <h5 class="card-title">Items Sold</h5>
                                                    <h2 class="card-text" id="totalItems">₵<%= totalItems.toFixed(2)  %></h2>
                                                    <p class="card-text"><small>Last 30 days</small></p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card bg-info text-white">
                                                <div class="card-body">
                                                    <h5 class="card-title">Average Sale</h5>
                                                    <h2 class="card-text" id="avgSale">₵<%= avgSale.toFixed(2) %></h2>
                                                    <p class="card-text"><small>Last 30 days</small></p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card bg-warning text-white">
                                                <div class="card-body">
                                                    <h5 class="card-title">Profit</h5>
                                                    <h2 class="card-text" id="avgSale">₵<%= Profit.toFixed(2) %></h2>
                                                    <p class="card-text"><small>Last 30 days</small></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Sales Chart -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <div class="card">
                                                <div class="card-body">
                                                    <div
                                                        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center border-bottom">
                                                        <h5 class="card-title mb-0">Sales Trend</h5>

                                                        <%- include('./forms/filterrecords') %>

                                                    </div>
                                                    <canvas id="salesChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Sales Management -->
                                    <div class="card">
                                        <div class="card-body">
                                            <div
                                                class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                                                <!-- Title with icon -->
                                                <div class="d-flex align-items-center">
                                                    <div>
                                                        <h5 class="card-title mb-1 fw-bold text-primary">Sales Records
                                                        </h5>
                                                        <p class="text-muted small mb-0">Manage and track your sales
                                                            transactions</p>
                                                    </div>
                                                </div>

                                                <!-- Actions Container -->
                                                <div>
                                                    <!-- New Sale Button -->
                                                    <button type="button"
                                                        class="btn btn-primary "
                                                        data-bs-toggle="modal" data-bs-target="#addSaleModal">
                                                        <i class='bx bx-plus fs-5'></i>
                                                        <span class="fw-semibold">New Sale</span>
                                                    </button>
                                                </div>
                                                
                                            </div>
                                            <!-- Export Dropdown -->
                                            <%- include('./forms/records') %>

                                            <!-- Sales Table -->
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Product</th>
                                                            <th>Quantity</th>
                                                            <th>Total Price</th>
                                                            <th>Amount Paid</th>
                                                            <th>Balance</th>
                                                            <th>Customer</th>
                                                            <th>Date</th>
                                                            <th>Status</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="salesTableBody">
                                                        <% sales.forEach(sale=> { %>
                                                            <tr>
                                                                <td data-label="Product">
                                                                    <%= sale.productId.name %>
                                                                </td>
                                                                <td data-label="Quantity">
                                                                    <%= sale.quantitySold %>
                                                                </td>
                                                                <td data-label="Total Price">
                                                                    <%= sale.payment.totalAmount ? `₵
                                                                        ${sale.payment.totalAmount.toFixed(2)}`
                                                                        : '₵0.00' %>
                                                                </td>
                                                                <td data-label="Amount Paid">
                                                                    <%= sale.payment.paidAmount ? `₵
                                                                        ${sale.payment.paidAmount.toFixed(2)}` : '₵0.00'
                                                                        %>
                                                                </td>
                                                                <td data-label="Balance">
                                                                    <%= sale.payment.balanceAmount ? `₵
                                                                        ${sale.payment.balanceAmount.toFixed(2)}`
                                                                        : '₵0.00' %>
                                                                </td>
                                                                <td data-label="Customer">
                                                                    <%= sale.customer.name %>
                                                                </td>
                                                                <td data-label="Date">
                                                                    <%= new Date(sale.saleDate).toLocaleDateString() %>
                                                                </td>
                                                                <td data-label="Status">
                                                                    <span
                                                                        class="badge p-2 bg-<%= sale.payment.paymentStatus === 'completed' ? 'success' : (sale.payment.paymentStatus === 'pending' ? 'warning' : 'danger') %>">
                                                                        <%= sale.payment.paymentStatus.replace('_', ' ') %>
                                                                    </span>
                                                                </td>
                                                                <td data-label="Actions">
                                                                    <div class="d-flex gap-2">
                                                                        <button class="btn btn-sm btn-info edit-sale"
                                                                            data-sale-id="<%= sale._id %>"
                                                                            data-product-id="<%= sale.productId._id %>"
                                                                            data-customer-id="<%= sale.customer._id %>"
                                                                            data-quantity="<%= sale.quantitySold %>"
                                                                            data-paid-amount="<%= sale.paidAmount ? sale.paidAmount : 0 %>"
                                                                            data-total-price="<%= sale.totalPrice ? sale.totalPrice : 0 %>"
                                                                            data-name="<%= sale.customer.name %>"
                                                                            data-email="<%= sale.customer.email %>"
                                                                            data-phone="<%= sale.customer.phone %>"
                                                                            data-payment-type="<%= sale.paymentType %>"
                                                                            data-status="<%= sale.status %>"
                                                                            data-bs-toggle="modal"
                                                                            data-bs-target="#editSaleModal">
                                                                            <i class='bx bx-edit-alt'></i>
                                                                        </button>
                                                                        <button
                                                                            class="btn btn-sm btn-danger delete-sale"
                                                                            data-sale-id="<%= sale._id %>"
                                                                            data-bs-toggle="modal"
                                                                            data-bs-target="#deleteSaleModal">
                                                                            <i class='bx bx-trash'></i>
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            <% }); %>
                                                    </tbody>
                                                </table>
                                            </div>

                                            <!-- Pagination -->
                                            <nav aria-label="Sales navigation"
                                                class="d-flex justify-content-between align-items-center mt-3">
                                                <div class="text-muted">
                                                    Showing
                                                    <%= (page - 1) * limit + 1 %>-
                                                        <%= Math.min(page * limit, total) %>
                                                            of
                                                            <%= total %> entries
                                                </div>
                                                <ul class="pagination mb-0">
                                                    <!-- Previous Button -->
                                                    <li class="page-item <%= page <= 1 ? 'disabled' : '' %>">
                                                        <a class="page-link"
                                                            href="?page=<%= page - 1 %>&limit=<%= limit %>&startDate=<%= startDate || '' %>&endDate=<%= endDate || '' %>">Previous</a>
                                                    </li>

                                                    <!-- Page Numbers -->
                                                    <% for (let i=1; i <=Math.ceil(total / limit); i++) { %>
                                                        <li class="page-item <%= i === page ? 'active' : '' %>">
                                                            <a class="page-link"
                                                                href="?page=<%= i %>&limit=<%= limit %>&startDate=<%= startDate || '' %>&endDate=<%= endDate || '' %>">
                                                                <%= i %>
                                                            </a>
                                                        </li>
                                                        <% } %>

                                                            <!-- Next Button -->
                                                            <li
                                                                class="page-item <%= page >= Math.ceil(total / limit) ? 'disabled' : '' %>">
                                                                <a class="page-link"
                                                                    href="?page=<%= page + 1 %>&limit=<%= limit %>&startDate=<%= startDate || '' %>&endDate=<%= endDate || '' %>">Next</a>
                                                            </li>
                                                </ul>
                                            </nav>

                                        </div>
                                    </div>
                                </div>
                        </div>
                </div>
            </div>
            </div>

            <!-- Add Sale Modal -->
            <div class="modal fade" id="addSaleModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add New Sale</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal">X</button>
                        </div>
                        <form action="/api/sales/create" method="POST">
                            <div class="modal-body">
                                <div class="row g-3">
                                    <!-- Product Selection -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="productId" class="form-label fw-semibold">Product</label>
                                            <select class="form-control" id="productId" name="productId" required>
                                                <option value="">Select Product</option>
                                                <% materials.forEach(function(product) { %>
                                                    <option value="<%= product._id %>"
                                                        data-price="<%= product.unitPrice %>"
                                                        data-stock="<%= product.stock %>">
                                                        <%= product.name %> - ₵<%= product.unitPrice %> (Stock: <%=
                                                                    product.stock %>)
                                                    </option>
                                                    <% }); %>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Customer Selection -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="customerId" class="form-label fw-semibold">Customer</label>
                                            <select class="form-control" id="customerId" name="customerId">
                                                <option value="">Select Customer</option>
                                                <% customers.forEach(function(customer) { %>
                                                    <option value="<%= customer._id %>">
                                                        <%= customer.name %> (Phone: <%= customer.phone %>)
                                                    </option>
                                                    <% }); %>
                                            </select>
                                            <p class="form-text text-danger display-6" style="font-size: 10px;">
                                                Select a customer if they are an existing customer; otherwise, provide
                                                customer details
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Quantity -->
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="quantitySold" class="form-label fw-semibold">Quantity</label>
                                            <input type="number" class="form-control" id="quantitySold"
                                                name="quantitySold" min="1" required placeholder="Enter quantity"">
                                            <div class=" form-text">Available stock: <span id="availableStock">-</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <h5>Customer Information </h5>
                                </div>
                                <!-- Customer Information -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="name" class="form-label fw-semibold">Customer Name</label>
                                        <input type="text" class="form-control" id="name" name="name">
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="phone" class="form-label fw-semibold">Customer Phone</label>
                                        <input type="tel" class="form-control" id="phone" name="phone">
                                    </div>
                                </div>

                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="email" class="form-label fw-semibold">Customer Email</label>
                                        <input type="email" class="form-control" id="email" name="email">
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <h5>Payment Information </h5>
                                </div>
                                <!-- Payment Information -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label fw-semibold">Payment Method</label>
                                        <select class="form-control" name="paymentMethod" id="paymentMethod" required>
                                            <option value="" disabled>Select Payment Method</option>
                                            <option value="cash">Cash</option>
                                            <option value="card">Card</option>
                                            <option value="credit">Purchase On Credit</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label fw-semibold">Payment Status</label>
                                        <select class="form-control" name="paymentStatus" id="paymentStatus" required>
                                            <option value="" disabled>Select Payment Status</option>
                                            <option value="paid">Paid</option>
                                            <option value="pending">Pending</option>
                                            <option value="partially_paid">Partially Paid</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="paidAmount" class="form-label fw-semibold">Amount Paid</label>
                                        <input type="number" class="form-control" id="paidAmount" name="paidAmount">
                                        <p class="form-text text-danger display-6" style="font-size: 10px;">

                                            Enter the amount paid only if the user makes a partial payment or purchases
                                            a product on credit.
                                        </p>
                                    </div>
                                </div>

                                <!-- Total Price -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label fw-semibold">Total Price</label>
                                        <div class="form-control bg-light" id="totalPrice">₵0.00</div>
                                    </div>
                                </div>
                            </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Sale</button>
                    </div>
                    </form>
                </div>
            </div>
            </div>

            <!-- Edit Sale Modal -->
            <div class="modal fade" id="editSaleModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Sale</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal">X</button>
                        </div>
                        <form id="editSaleForm" method="POST">
                            <div class="modal-body">
                                <div class="row g-3">
                                    <input type="hidden" id="editSaleId" name="saleId">
                                    <div class="col-md-6">
                                        <label for="editProductId" class="form-label">Product</label>
                                        <select class="form-control" id="editProductId" name="productId" required>
                                            <option value="">Select Product</option>
                                            <% materials.forEach(function(product) { %>
                                                <option value="<%= product._id %>" data-price="<%= product.unitPrice %>"
                                                    data-stock="<%= product.stock %>">
                                                    <%= product.name %> - ₵<%= product.unitPrice %> (Stock: <%=
                                                                product.stock %>)
                                                </option>
                                                <% }); %>
                                        </select>
                                    </div>
                                    <!-- Customer Selection -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editCustomerId" class="form-label fw-semibold">Customer</label>
                                            <select class="form-control" id="editCustomerId" name="customerId">
                                                <option value="">Select Customer</option>
                                                <% customers.forEach(function(customer) { %>
                                                    <option value="<%= customer._id %>">
                                                        <%= customer.name %> (Phone: <%= customer.phone %>)
                                                    </option>
                                                    <% }); %>
                                            </select>
                                            <p class="form-text text-danger" style="font-size: 10px;">
                                                Select a customer if they are an existing customer; otherwise, provide
                                                customer details.
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Quantity -->
                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="editQuantitySold"
                                                class="form-label fw-semibold">Quantity</label>
                                            <input type="number" class="form-control" id="editQuantitySold"
                                                name="quantitySold" min="1" required>
                                            <div class="form-text">Available stock: <span
                                                    id="editAvailableStock">-</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <h5>Customer Information </h5>
                                    </div>

                                    <!-- Customer Information -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editName" class="form-label fw-semibold">Customer Name</label>
                                            <input type="text" class="form-control" id="editName" name="name" required>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editPhone" class="form-label fw-semibold">Customer Phone</label>
                                            <input type="tel" class="form-control" id="editPhone" name="phone" required>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <div class="form-group">
                                            <label for="editEmail" class="form-label fw-semibold">Customer Email</label>
                                            <input type="email" class="form-control" id="editEmail" name="email"
                                                required>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <h5>Payment Information </h5>
                                    </div>

                                    <!-- Payment Information -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">Payment Method</label>
                                            <select class="form-control" name="paymentMethod" id="editPaymentMethod"
                                                required>
                                                <option value="" disabled>Select Payment Method</option>
                                                <option value="cash">Cash</option>
                                                <option value="card">Card</option>
                                                <option value="credit">Purchase On Credit</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">Payment Status</label>
                                            <select class="form-control" name="paymentStatus" id="editPaymentStatus"
                                                required>
                                                <option value="" disabled>Select Payment Status</option>
                                                <option value="paid">Paid</option>
                                                <option value="pending">Pending</option>
                                                <option value="partially_paid">Partially Paid</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="editPaidAmount" class="form-label fw-semibold">Amount
                                                Paid</label>
                                            <input type="number" class="form-control" id="editPaidAmount"
                                                name="paidAmount">
                                            <p class="form-text text-danger" style="font-size: 10px;">
                                                Enter the amount paid only if the user makes a partial payment or
                                                purchases
                                                a product on credit.
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Total Price -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label fw-semibold">Total Price</label>
                                            <div class="form-control bg-light" id="editTotalPrice">₵0.00</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-primary">Update Sale</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            </div>

            <!-- Delete Sale Modal -->
            <div class="modal fade" id="deleteSaleModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Delete Sale</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete this sale? This action cannot be undone.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                        </div>
                    </div>
                </div>
            </div>

            <div><%= stats %></div>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

            <script>
                document.addEventListener('DOMContentLoaded', function () {

                    // Initialize Chart.js
                    const ctx = document.getElementById('salesChart').getContext('2d');
                    const salesChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Sales Amount',
                                data: [],
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: value => '₵' + value
                                    }
                                }
                            }
                        }
                    });
                    
                    loadSalesData();
                    // Load Sales Data
                    async function loadSalesData() {
                        try {
                            console.log(" Response Stafss", `<%= stats  %>`)
                            
                            const response = JSON.parse(`<%= stats  %>`);

                            console.log(" Response Stafss", `<%= stats  %>`)
                            // Update chart
                            salesChart.data.labels = data.map(item =>
                                new Date(item._id.year, item._id.month - 1).toLocaleDateString()
                            );
                            salesChart.data.datasets[0].data = data.map(item => item.totalSales);
                            salesChart.update();

                            // Update summary cards
                            const totalSales = data.reduce((sum, item) => sum + item.totalSales, 0);
                            const totalItems = data.reduce((sum, item) => sum + item.totalItems, 0);
                            const avgSale = totalSales / data.reduce((sum, item) => sum + item.count, 0);
                           
                            document.getElementById('totalSales').textContent = '₵' + totalSales.toFixed(2);
                            document.getElementById('totalItems').textContent = totalItems;
                            document.getElementById('avgSale').textContent = '₵' + avgSale.toFixed(2);
                        } catch (error) {
                            console.error('Error loading sales data:', error);
                        }
                    }

                    // Initialize date range buttons
                    const formData = document.getElementById('filterForm')
                    console.log(formData)
                    formData.onsubmit((e) => {
                        console.log("Form Submited.......................")
                        console.log(e)
                        console.log(e.target)
                    })

                    document.querySelectorAll('[data-range]').forEach(button => {
                        button.addEventListener('click', function () {
                            loadSalesData(this.dataset.range);
                            // Update active state
                            document.querySelectorAll('[data-range]').forEach(btn =>
                                btn.classList.remove('active')
                            );
                            this.classList.add('active');
                        });
                    });

                    // Calculate total price based on quantity and unit price
                    function updateTotalPrice(form) {
                        const quantity = parseInt(form.quantitySold.value) || 0;
                        const select = form.productId;
                        const option = select.options[select.selectedIndex];
                        const unitPrice = parseFloat(option.dataset.price) || 0;
                        const total = quantity * unitPrice;

                        const totalPriceElement = form.closest('.modal').querySelector('[id$="TotalPrice"]');
                        totalPriceElement.textContent = '₵' + total.toFixed(2);
                    }

                    // Add event listeners for quantity changes
                    ['addSaleForm', 'editSaleForm'].forEach(formId => {
                        const form = document.getElementById(formId);
                        form.quantitySold.addEventListener('input', () => updateTotalPrice(form));
                        form.productId.addEventListener('change', () => updateTotalPrice(form));
                    });


                    // Load initial data
                });
            </script>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    // Calculate total price for new sale
                    const calculateTotal = (quantity, price) => {
                        return quantity && price ? (quantity * price).toFixed(2) : '0.00';
                    };

                    // Handle new sale
                    const productSelect = document.getElementById('productId');
                    const quantityInput = document.getElementById('quantitySold');
                    const totalPriceDiv = document.getElementById('totalPrice');
                    const stockSpan = document.getElementById('availableStock');

                    const updateNewSaleTotal = () => {
                        const selectedOption = productSelect.selectedOptions[0];
                        const price = selectedOption ? parseFloat(selectedOption.dataset.price) : 0;
                        const quantity = parseInt(quantityInput.value) || 0;
                        totalPriceDiv.textContent = `₵${calculateTotal(quantity, price)}`;
                        stockSpan.textContent = selectedOption ? selectedOption.dataset.stock : '-';
                    };

                    productSelect.addEventListener('change', updateNewSaleTotal);
                    quantityInput.addEventListener('input', updateNewSaleTotal);

                    // Handle edit sale
                    const editButtons = document.querySelectorAll('.edit-sale');
                    editButtons.forEach(button => {
                        button.addEventListener('click', () => {
                            const saleId = button.dataset.saleId;
                            const productId = button.dataset.productId;
                            const quantity = button.dataset.quantity;
                            const customer = button.dataset.customer;
                            const paymentMethod = button.dataset.paymentMethod;
                            const paymentStatus = button.dataset.paymentStatus;
                            const paidAmount = button.dataset.paidAmount;

                            document.getElementById('editSaleId').value = saleId;
                            document.getElementById('editProductId').value = productId;
                            document.getElementById('editQuantitySold').value = quantity;
                            document.getElementById('editCustomerName').value = customer;
                            document.getElementById('editPaymentMethod').value = paymentMethod;
                            document.getElementById('editPaymentStatus').value = paymentStatus;
                            document.getElementById('editPaidAmount').value = paidAmount;

                            // Update form action
                            const editForm = document.getElementById('editSaleForm');
                            editForm.action = `/api/sales/${saleId}`;
                            editForm.method = 'PUT';

                            // Calculate total
                            const selectedOption = document.getElementById('editProductId').selectedOptions[0];
                            const price = selectedOption ? parseFloat(selectedOption.dataset.price) : 0;
                            document.getElementById('editTotalPrice').textContent = `₵${calculateTotal(quantity, price)}`;
                            document.getElementById('editAvailableStock').textContent = selectedOption ? selectedOption.dataset.stock : '-';
                        });
                    });

                    // Handle edit sale calculations
                    const editProductSelect = document.getElementById('editProductId');
                    const editQuantityInput = document.getElementById('editQuantitySold');
                    const editTotalPriceDiv = document.getElementById('editTotalPrice');
                    const editStockSpan = document.getElementById('editAvailableStock');

                    const updateEditSaleTotal = () => {
                        const selectedOption = editProductSelect.selectedOptions[0];
                        const price = selectedOption ? parseFloat(selectedOption.dataset.price) : 0;
                        const quantity = parseInt(editQuantityInput.value) || 0;
                        editTotalPriceDiv.textContent = `₵${calculateTotal(quantity, price)}`;
                        editStockSpan.textContent = selectedOption ? selectedOption.dataset.stock : '-';
                    };

                    editProductSelect.addEventListener('change', updateEditSaleTotal);
                    editQuantityInput.addEventListener('input', updateEditSaleTotal);

                    // Handle delete sale
                    const deleteButtons = document.querySelectorAll('.delete-sale');
                    const confirmDeleteButton = document.getElementById('confirmDelete');
                    let saleToDelete = null;

                    deleteButtons.forEach(button => {
                        button.addEventListener('click', () => {
                            saleToDelete = button.dataset.saleId;
                        });
                    });

                    confirmDeleteButton.addEventListener('click', async () => {
                        if (saleToDelete) {
                            try {
                                const response = await fetch(`/api/sales/${saleToDelete}`, {
                                    method: 'DELETE',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                });
                                // Close the modal and refresh the page
                                const deleteModal = new bootstrap.Modal(document.getElementById('deleteSaleModal'));
                                deleteModal.hide();
                                window.location.reload();

                            } catch (error) {
                                console.error('Error:', error);
                                alert('Error deleting sale');
                            }
                        }
                    });
                });

            </script>
            <%- include('layouts/footer') %>

    </body>

</html>